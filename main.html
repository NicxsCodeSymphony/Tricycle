<!DOCTYPE >
<html lang="en" dir="ltr">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>CTU Tricycle Booking</title>
  <link rel="stylesheet" href="/css/popup.css">
  <link rel="stylesheet" type="text/css" href="css/main.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <link href='https://fonts.googleapis.com/css?family=Poppins' rel='stylesheet'>
</head>



<body>

  <header>
    <i class="fa-solid fa-arrow-left logout" onclick="logout()"></i>
    <p style="font-size: 14px; margin-top: 1.1px;">Tricycle Booking</p>
    <i></i>
  </header>

  <div class="section1">
    <p>Welcome</p>
    <h3 class="stand" id="displayName">your next tricycle</h3>
  </div>

  <div class="section2">
    <div class="left from">
      <p>From</p>
      <h2>DBN</h2>
      <span>CTU-Daanbantayan</span>
    </div>

    <div class="right to" onclick="showTo('to')">
      <p>To</p>
      <h2>DBN</h2>
      <span class="toPlace">Click Here</span>
    </div>
  </div>


<div class="section3">
    <div class="container">
      <div class="left departure" onclick="showCalendar('date')">
        <p>Date</p>
        <h4 class="date" id="result2">Click Here</h4>
      </div>
  </div>


  <div class="section3">
    <div class="container">
      <div class="left departure" onclick="showCalendar('departure')">
        <p>Departure</p>
        <h4 class="date" id="result">Click Here</h4>
      </div>

      <div class="left return" onclick="showCalendar('return')">
        <p>Return</p>
        <h4 class="date" id="result1">Click Here</h4>
      </div>
    </div>
  </div>

  


  <div class="section3">
    <div class="container">
      <div class="left">
        <p style="text-align: center">No. of Passenger</p>
        <div class="number-container">
          <button class="button" onclick="decrement('adult')">-</button>
          <div class="number" id="adultCount">1</div>
          <button class="button" onclick="increment('adult')">+</button>
        </div>
      </div>

      
    </div>
  </div>

  <!-- POPUP SECTION -->
  <!-- Update the styles for the time input in departurePopup -->

 <div id="datePopup" class="popup">
    <button onclick="hideCalendarPopup('date')">Close</button>
    <div class="wrapper">
      <p style="text-align: center;">Choose a Date</p>
      <input type="date" style="position: absolute; left: 40%; top: 60%; transform: translate(-50%, -50%); width: 200px; height: 40px; font-size: 16px;" id="dateInput2" oninput="updateDateResult()">
    </div>
  </div>


<div id="departurePopup" class="popup">
  <button onclick="hideCalendarPopup('departure')">Close</button>
  <div class="wrapper">
    <p style="text-align: center;">Choose a Time for Departure</p>
    <!-- Update styles for larger and centered input -->
    <input type="time" name="" value="" style="position: absolute; left: 50%; top:60%; transform: translate(-50%, -50%); width: 200px; height: 40px; font-size: 16px;" id="dateInput" onclick="showTimePopup('departure')" oninput="convertDateFormat()">
  </div>
</div>

<!-- Update the styles for the time input in returnPopup -->
<div id="returnPopup" class="popup">
  <button onclick="hideCalendarPopup('return')">Close</button>
  <div class="wrapper">
    <p style="text-align: center;">Choose a Time for Return</p>
    <!-- Update styles for larger and centered input -->
    <input type="time" name="" value="" style="position: absolute; left: 50%; top: 60%; transform: translate(-50%, -50%); width: 200px; height: 40px; font-size: 16px;" id="dateInput1" onclick="showTimePopup('return')" oninput="convertDateFormat1()">
  </div>
</div>


  <div id="toPopup" class="popup">
    <button onclick="hideCalendarPopup('to')">Close</button>

    <div class="to-wrappers">
    <p>From</p>
    <input type="text" name="" value="Daanbantayan">
    <h5>Select To</h5>

    <div class="scroll-sec">

    

    <div class="place" id="b1" onclick="place('Bagay', 30)" data-price="30">
      <p>Bagay</p>
      <span>Daanbantayan</span>
    </div>

    <div class="place" id="b2"  onclick="place('Bakhawan',30)"  data-price="30">
      <p>Bakhawan</p>
      <span>Medellin</span>
    </div>

    <div class="place" id="b3"  onclick="place('Bateria',45)"  data-price="45">
      <p>Bateria</p>
      <span>Daanbantayan</span>
    </div>

    <div class="place" id="b3" onclick="place('Bitoon',45)"  data-price="45">
        <p>Bitoon</p>
        <span>Daanbantayan</span>
      </div>

      <div class="place" id="b3" onclick="place('Calape',35)" data-price="35">
        <p>Calape</p>
        <span>Daanbantayan</span>
      </div>
      <div class="place" id="b3" onclick="place('Dalingding',55)"  data-price="55">
        <p>Dalingding</p>
        <span>Daanbantayan</span>
      </div>
      <div class="place" id="b3" onclick="place('Lanao',30)"  data-price="30">
        <p>Lanao</p>
        <span>Daanbantayan</span>
      </div>

      <div class="place" id="b3" onclick="place('Malbago',45)"  data-price="45">
        <p>Malbago</p>
        <span>Daanbantayan</span>
      </div>

      <div class="place" id="b3" onclick="place('Malingin',30)"  data-price="30">
        <p>Malingin</p>
        <span>Daanbantayan</span>
      </div>

      <div class="place" id="b3" onclick="place('Maya', 20)"  data-price="20">
        <p>Maya</p>
        <span>Daanbantayan</span>
      </div>

      <div class="place" id="b3" onclick="place('Pajo', 25)"  data-price="25">
        <p>Pajo</p>
        <span>Daanbantayan</span>
      </div>

      <div class="place" id="b3" onclick="place('Paypay',30)"  data-price="30">
        <p>Paypay</p>
        <span>Daanbantayan</span>
      </div>

      <div class="place" id="b3" onclick="place('Talisay',30)"  data-price="30">
        <p>Talisay</p>
        <span>Daanbantayan</span>
      </div>

      <div class="place" id="b3" onclick="place('Tapilon',15)"  data-price="15">
        <p>Tapilon</p>
        <span>Daanbantayan</span>
      </div>

      <div class="place" id="b3" onclick="place('Tinubdan',30)"  data-price="30">
        <p>Tinubdan</p>
        <span>Daanbantayan</span>
      </div>

      <div class="place" id="b3" onclick="place('Tominjao',45)"  data-price="45">
        <p>Tominjao</p>
        <span>Daanbantayan</span>
      </div>
</div>

    </div>
  </div>

  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
  </div>

  <div class="custom-alert" id="customAlert"></div>
   <div class="overlay"></div>


  <div class="btnCon">
  <input type="button" name=""id="ctaBtn" value="Find your Tricycle">
  </div>
  
  <script type="module">
          import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getDatabase, ref, onValue, push, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

// Firebase configuration (same as in your provided code)
const firebaseConfig = {
  apiKey: "AIzaSyCsArVB68AapedELqHyLgFoDLrIlNMMYkE",
  authDomain: "tricycle-reservation-app.firebaseapp.com",
  databaseURL: "https://tricycle-reservation-app-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "tricycle-reservation-app",
  storageBucket: "tricycle-reservation-app.appspot.com",
  messagingSenderId: "500857377124",
  appId: "1:500857377124:web:fb78eab96be7a5ae6c6a71"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);

// Get Auth and Database instances
const auth = getAuth();
const database = getDatabase();

// Auth State Changed (check if user is logged in)
onAuthStateChanged(auth, (user) => {
        if (user) {
            // User is signed in
            // Retrieve user's name from the database
            const userRef = ref(database, `users/${user.uid}`);
            onValue(userRef, (snapshot) => {
                const userData = snapshot.val();
                const fullName = userData ? userData.fullName : user.displayName;

                // Display user's name
                document.getElementById('displayName').innerText = fullName;
            });
        } else {  
            document.getElementById('userFullName').style.display = 'none';
        }
    });

// Logout Function
window.logout = function() {
  signOut(auth);
  window.location.href = "index.html";
};

let initialPayment;

// Update the place function
window.place = function (placeName, price) {
  initialPayment = price; // Store the second parameter in initialPayment
  document.querySelector('.toPlace').textContent = placeName + ', Daanbantayan'; // Update the UI
  hideCalendarPopup('to');
};

window.showTimePopup = function (type) {
    const timeInput = document.getElementById(`dateInput${type === 'departure' ? '' : '1'}`);
    const resultElement = document.getElementById(`result${type === 'departure' ? '' : '1'}`);

    timeInput.addEventListener('change', function () {
      const selectedTime = timeInput.value;

      // Convert the selected time to the desired format
      const formattedTime = formatTime(selectedTime);

      hideCalendarPopup(type);

      // Display the selected time in the respective date result
      resultElement.textContent = formattedTime;
    });
  };

   window.updateDateResult = function () {
  const dateInput = document.getElementById('dateInput2');
  const result2Element = document.getElementById('result2');

  const selectedDate = dateInput.value;

  hideCalendarPopup('date');

  // Display the formatted date in the result2 element
  result2Element.textContent = formatDate(selectedDate);
};

  // Function to format time as "1:30 AM"
  function formatTime(selectedTime) {
    const [hours, minutes] = selectedTime.split(':');
    let period = 'AM';

    // Convert to 12-hour format
    let formattedHours = parseInt(hours);
    if (formattedHours >= 12) {
      period = 'PM';
      formattedHours = formattedHours !== 12 ? formattedHours - 12 : formattedHours;
    }

    // Ensure leading zero for single-digit minutes
    const formattedMinutes = minutes.padStart(2, '0');

    return `${formattedHours}:${formattedMinutes} ${period}`;
  }

  function formatDate(selectedDate) {
  const months = [
    "Jan", "Feb", "Mar", "Apr", "May", "Jun",
    "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"
  ];

  const [year, month, day] = selectedDate.split('-');
  const monthName = months[parseInt(month, 10) - 1];

  return `${monthName} ${parseInt(day, 10)}, ${year}`;
}


  // Event listener for "Find your Tricycle" button
  document.getElementById('ctaBtn').addEventListener('click', function () {
    const toPlaceElement = document.querySelector('.toPlace');
    const resultElement = document.getElementById('result');
    const result1Element = document.getElementById('result1');
    const adultCountElement = document.getElementById('adultCount');
    const dateElement = document.getElementById('result2');

    const toPlace = toPlaceElement ? toPlaceElement.textContent : null;
    const pickupTime = resultElement ? resultElement.textContent : null;
    const departureTime = result1Element ? result1Element.textContent : null;
    const passengerCount = adultCountElement ? adultCountElement.textContent : null;
    const dateDepart = dateElement ? dateElement.textContent : null;

   function showAlert(message) {
  const customAlert = document.getElementById('customAlert');
  const overlay = document.querySelector('.overlay');

  customAlert.innerText = message;
  customAlert.style.display = 'block';

  overlay.classList.add('show-overlay'); // Show the overlay

  setTimeout(() => {
    customAlert.style.display = 'none';
    overlay.classList.remove('show-overlay'); // Hide the overlay
  }, 2000);
}

    // Check if any of the required elements have the value "Click Here"
    if (toPlace === "Click Here" || pickupTime === "Click Here" || departureTime === "Click Here" || passengerCount === "Click Here") {
      showAlert('Please choose values for all sections before finding your tricycle.');
    } else {
      // Check if pickup time is later than departure time
      const pickupTimestamp = Date.parse(`2023-01-01 ${pickupTime}`);
      const departureTimestamp = Date.parse(`2023-01-01 ${departureTime}`);

      if (pickupTimestamp >= departureTimestamp) {
        showAlert('Pickup time should be earlier than departure time.');
      } else {
        // Wait for the user to choose a place before writing to the database
        if (initialPayment !== undefined) {
          // Create a new entry in the database
          const newEntryRef = push(ref(database, 'tricycleBookings'));
          const newEntryKey = newEntryRef.key;

          // Set the data in the database, including the initialPayment
          set(ref(database, `tricycleBookings/${newEntryKey}`), {
            toPlace,
            pickupTime,
            departureTime,
            passengerCount,
            initialPayment,
            dateDepart
          });

          localStorage.setItem('toPlace', toPlace);
    localStorage.setItem('pickupTime', pickupTime);
    localStorage.setItem('departureTime', departureTime);
    localStorage.setItem('passengerCount', passengerCount);
    localStorage.setItem('initialPayment', initialPayment);
    localStorage.setItem('dateDepart', dateDepart);

        loadingOverlay.style.display = 'flex';
          // Reset the initialPayment after storing data
          initialPayment = undefined;

        // Redirect to the confirmation page with the newEntryKey as a parameter
        window.location.href = `tricycle.html?toPlace=${toPlace}&pickupTime=${pickupTime}&departureTime=${departureTime}`;
        } else {
          showAlert('Please choose a place before finding your tricycle.');
        }
      }
    }
  });

  </script>

<script src="js/popup.js"></script>


</body>
</html>
